Параметры адресной строки
=========================

Все параметры передаются в fragment-части `URL`_-а, т.е. после символа :code:`#`.
Формат аналогичен параметрам query string:
имена параметров отделяются от значений знаком :code:`=`,
параметры соединяются знаком :code:`&`,
значения при необходимости кодируются в `percent-encoding`_.
Большинство параметров требуют список из нескольких значений,
значения разделяются знаком :code:`/`,
при этом в percent-encoding кодируются элементы списка, но не разделяющий их :code:`/`.

.. _URL: https://en.wikipedia.org/wiki/URL
.. _percent-encoding: https://en.wikipedia.org/wiki/Percent-encoding

 * `Параметры состояния интерфейса`_
 * `Параметры для загрузки треков`_

Параметры состояния интерфейса
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

m: позиция карты
----------------

Пример:
    .. code::

       m=13/48.52618/39.29019

Значения:
    :1: уровень зума от 0 до 18
    :2: широта в градусах
    :3: долгота в градусах

l: включенные слои
------------------

Пример:
    .. code::

       l=O/D/Wp

Значения:
    список кодов слоёв

Коды можно получить, включая нужные слои в интерфейсе.


n2: панорамы
------------

Пример:
    .. code::

       n2=_gwm/g/54.128460/41.681023/330.0/-7.6/2.0

p: настройки печати
-------------------

Пример:
    .. code::

       p=500/300/auto/210/297/3/3/3/3/54.12945/41.68213/1/54.32774/41.43768/0/0

j: настройки экспорта в JNX
---------------------------

Пример:
    .. code::

       j=53.84853/41.24817/54.40296/42.11609

Параметры для загрузки треков
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Треки можно загрузить:

 * открыв сайт по ссылке
 * заменив адрес в адресной строке при уже открытом сайте
 * вставив ссылку в поле ввода над списком треков.
   При этом из ссылки загрузятся только треки,
   но не состояние   интерфейса
 * вставив в поле ввода над списком треков один или несколько параметров,
   добавив перед ними символ :code:`#`,
   например: :code:`#nktp=11/22`

nktk: закодированный трек
-------------------------

Пример:
    .. code::

       nktk=QklOZXcgdHJhY2tBQoDt6oDN_Z2BgD7Xc0FAQA
Значения:
    строки, кодирующие трек и точки

Такие строки создавались в старой версии сайта,
в текущей версии их создать нельзя.


nktl: идентификатор трека
-------------------------

Пример:
    .. code::

       nktl=-fgDleyE-9HXaIjH_HG0wQ

Значения:
       строки-идентификаторы для загрузки треков с сервера nakarte

Идентификаторы создаются в интерфейсе при клике на пункт :guilabel:`Copy link to clipboad` в контекстном меню трека и
:guilabel:`Copy all tracks to clipborad` в меню списка треков.
По одному идентификатору может хранится несколько треков.
В параметре можно передать несколько идентификаторов, хотя в интерфейсе такие ссылки сделать нельзя.


nktu: ссылки на треки
---------------------

Пример:
    .. code::

       nktu=http%3A%2F%2Fslazav.mccme.ru%2Fgps%2F20180415wz.zip/https%3A%2F%2Fwww.strava.com%2Factivities%2F1989612737

Значения:
    URL-ы треков, закодированные в percent-encoding

URL-ы могут указывать на файлы поддерживаемых форматов, включая zip, и на сервисы типа Strava, GPSies и т.д.

Параметры отображения загруженных треков:

 * цвет назначается автоматически
 * отображение включено
 * отображение отметок расстояние выключено


nktp: путевая точка
-------------------

Пример:
    .. code::

       nktp=58.87768/31.50055/Point name

Значения:
    :1: широта в градусах
    :2: долгота в градусах
    :3: имя (может отсутствовать, по умолчанию "Point")

При загрузке создаётся новый трек с единственной путевой точкой,
имя трека такое же, как у точки.

nktj: треки и точки с настройками отображения
---------------------------------------------

Пример:
    .. code::

       nktj=W3sicCI6IFt7ImxuIjogMzQuNTYsICJsdCI6IDI0LjU2LCAibiI6ICJNeSBwb2ludCJ9XSwgInQiOiBbW1s1Ni4yNCwgNDUuNjddLCBbNTcuMjQsIDQ2LjY3XV1dLCAibiI6ICJUaGUgdHJhY2sifSwgeyJ1IjogImh0dHBzOi8vd3d3LnN0cmF2YS5jb20vYWN0aXZpdGllcy8xOTg5NjEyNzM3IiwgImMiOiAzLCAidiI6IGZhbHNlLCAibSI6IHRydWUsICJuIjogIkFub3RoZXIgdHJhY2sifV0=

Значения:
    строки с закодированными треками

Параметр позволяет:

 * настроить отображение трека
 * создать несколько точек
 * задать небольшой трек прямо в значении параметра
 * создать несколько треков

.. note::

   Разные браузеры имеют разные ограничения на размер URL.
   Рекомендуется не создавать такие значения параметра nktj, при которых общая длина URL-а превысит 2083 символа.

Треки описываются в формате JSON и кодируются в `URL-safe Base64`_

    .. _URL-safe BASE64: https://en.wikipedia.org/wiki/Base64#URL_applications

Пример описания двух треков в JSON:

.. code-block:: json

    [
        {
            "n": "The track",
            "p": [
                    {
                        "n": "My point",
                        "lt": 24.56,
                        "ln": 34.56
                    }
            ],
            "t": [
                    [
                        [
                            56.24,
                            45.67
                        ],
                        [
                            57.24,
                            46.67
                        ]
                    ]
            ]
        },
        {
            "n": "Another track",
            "c": 3,
            "v": false,
            "m": true,
            "u": "https://www.strava.com/activities/1989612737"
        }
    ]


Каждый трек описывается словарём.
Словари объединяются в список, один трек тоже помещается в список.

Словари треков
++++++++++++++

.. list-table:: Поля 
    :header-rows: 1

    - - имя
      - тип
      - значение по-умолчанию
      - описание
    - - n
      - строка
      - Track
      - имя трека
    - - u
      - строка
      - нет
      - URL, по которому загрузить трек, указывает на файл или сервис
    - - p
      - список словарей
      - нет
      - описания путевых точек
    - - t
      - список
      - нет
      - описания линий треков
    - - c
      - число
      - авто
      - цвет
    - - v
      - булев
      - true
      - показ трека включен
    - - m
      - булев
      - false
      - показ отметок длины включен

Данные треков загружаются либо по ссылке из поля :code:`u`, либо из описаний в полях :code:`p` и :code:`t`. При наличии :code:`u` поля :code:`p` и :code:`t` игнорируются.

Имя трека используется по-разному в зависимости от наличия полей :code:`u`, :code:`p`, :code:`t`: 

 * Если трек загружается по ссылке из поля :code:`u`, то при наличии поля :code:`n` имя трека берется из него, иначе остаётся автоматическое (обычно, имя файла). При этом, если будет загружен zip-архив, содержаший несколько треков, параметр :code:`n` игнорируется.
 * Если трек создаётся из описаний в полях :code:`p` и :code:`t`, то при наличии поля :code:`n` имя трека берется из него, иначе будет "Track"

Цвет трека задаётся числом:

===== ====
Число цвет
===== ====
0     синий
1     оранжевый
2     голубой
3     красный
4     фиолетовый
5     желтый
===== ====

Словари точек
++++++++++++++

.. list-table:: Поля 
    :header-rows: 1

    - - имя
      - тип
      - описание
    - - n
      - строка
      - Имя точки, поле обязательное
    - - lt
      - число 
      - широта
    - - ln
      - число 
      - долгота


Линии треков
++++++++++++
 * описание состоит из списка сегментов
 * сегмент состоит из списка точек
 * точка описывается списком из двух элементов, широты и долготы.